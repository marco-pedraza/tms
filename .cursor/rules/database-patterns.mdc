---
description: Database patterns and repository implementation
globs: **/server/**/*.repository.ts,**/server/**/*.schema.ts
alwaysApply: false
---

# Database Patterns

> **ðŸ“– See `AGENTS.md` for complete database patterns and available base repository methods**

## Essential Description

Each feature defines its schema locally. Base repository (`@repo/base-repo`) provides complete CRUD. Only extend when you need specific methods (relationships, transformations). Use `function` declarations, not arrow functions.

## Practical Examples

### Minimal Repository

```typescript
import { createBaseRepository } from '@repo/base-repo';
import { db } from '../db-service';
import { featureSchema } from './feature.schema';
import type { Feature, CreatePayload, UpdatePayload } from './feature.types';

export function createFeatureRepository() {
  return createBaseRepository<Feature, CreatePayload, UpdatePayload, typeof featureSchema>(
    db,
    featureSchema,
    'Feature',
    {
      searchableFields: [featureSchema.name],
      softDeleteEnabled: true,
    }
  );
}

export const featureRepository = createFeatureRepository();
```

### Repository with Relationships

```typescript
export function createFeatureRepository() {
  const baseRepository = createBaseRepository<Feature, CreatePayload, UpdatePayload, typeof schema>(
    db,
    schema,
    'Feature',
    { searchableFields: [schema.name] }
  );

  async function findOneWithRelations(id: number): Promise<FeatureWithRelations> {
    const result = await db.query.features.findFirst({
      where: eq(schema.id, id),
      with: { relatedEntity: true },
    });
    if (!result) throw new NotFoundError(`Feature ${id} not found`);
    return result;
  }

  return {
    ...baseRepository,
    findOneWithRelations,
  };
}
```

### Simple Schema

```typescript
import { pgTable, serial, text, boolean, timestamp, uniqueIndex } from 'drizzle-orm/pg-core';
import { isNull } from 'drizzle-orm';

export const features = pgTable(
  'features',
  {
    id: serial('id').primaryKey(),
    name: text('name').notNull(),
    code: text('code').notNull(),
    active: boolean('active').notNull().default(true),
    createdAt: timestamp('created_at').defaultNow(),
    updatedAt: timestamp('updated_at').defaultNow(),
    deletedAt: timestamp('deleted_at'),
  },
  (table) => [
    uniqueIndex().on(table.name).where(isNull(table.deletedAt)),
    uniqueIndex().on(table.code).where(isNull(table.deletedAt)),
  ]
);
```

### Schema with Relations

```typescript
import { pgTable, serial, integer, text } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';
import { cities } from '../cities/cities.schema';

export const features = pgTable('features', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  cityId: integer('city_id').references(() => cities.id),
});

export const featuresRelations = relations(features, ({ one }) => ({
  city: one(cities, {
    fields: [features.cityId],
    references: [cities.id],
  }),
}));
```

### Transactions

```typescript
await repository.transaction(async (txRepo, tx) => {
  const entity = await txRepo.create(data1);
  const txRelatedRepo = relatedRepository.withTransaction(tx);
  await txRelatedRepo.create({ ...data2, entityId: entity.id });
});
```

## References

- See `AGENTS.md` section "Database" for complete patterns
- See `packages/base-repo/src/base-repository.ts` for available base repository methods
