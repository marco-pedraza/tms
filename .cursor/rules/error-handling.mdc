---
description: Error handling patterns in Encore applications
globs: *.controller.ts,**/server/**/*.domain.ts,**/server/**/*.entity.ts
alwaysApply: false
---

# Error Handling Patterns

> **ðŸ“– See `AGENTS.md` for complete error handling and validation patterns**

## Essential Description

Use `FieldErrorCollector` for validation. Middleware automatically transforms domain errors to API errors. Don't use try/catch in controllers. **Entity Pattern**: use `feature-name.errors.ts` with `createDomainErrorHelpersWithFields`. **Repository Pattern**: use `standardFieldErrors` from `shared/errors.ts`.

## Practical Examples

### Domain Validation (Repository Pattern)

```typescript
import { FieldErrorCollector } from '@repo/base-repo';
import { standardFieldErrors } from '../../shared/errors';

export async function validateFeature(payload: CreatePayload, currentId?: number): Promise<void> {
  const collector = new FieldErrorCollector();

  const conflicts = await repository.checkUniqueness(
    [{ field: schema.name, value: payload.name }],
    currentId
  );

  conflicts.forEach((conflict) => {
    standardFieldErrors.duplicate('Feature', conflict.field, conflict.value, collector);
  });

  collector.throwIfErrors();
}
```

### Domain Errors (Entity Pattern)

```typescript
// feature.errors.ts
import { FieldErrorCollector } from '@repo/base-repo';
import { createDomainErrorHelpersWithFields } from '@/shared/domain/domain-errors';

const FEATURE_ERROR_CONFIG = {
  invalidState: {
    message: 'Invalid state for this operation',
    field: 'state',
    code: 'INVALID_STATE',
  },
} as const;

const baseErrors = createDomainErrorHelpersWithFields(FEATURE_ERROR_CONFIG);

export const featureErrors = {
  ...baseErrors,
};
```

**Usage in Entity**:

```typescript
function validateBusinessRules(data: Payload): void {
  const collector = new FieldErrorCollector();
  if (invalidCondition) {
    featureErrors.invalidState(collector, data.state);
  }
  collector.throwIfErrors();
}
```

### Repository Errors

```typescript
async function findOneWithRelations(id: number) {
  const result = await db.query.features.findFirst({ where: eq(schema.id, id) });
  if (!result) {
    throw new NotFoundError(`Feature ${id} not found`);
  }
  return result;
}
```

### Controller (No try/catch)

```typescript
export const createFeature = api(
  { method: 'POST', path: '/features/create', auth: true },
  async (params: CreatePayload): Promise<Feature> => {
    await validateFeature(params); // Throws FieldValidationError if fails
    return await repository.create(params); // Throws NotFoundError if fails
  }
);
```

## Error Mapping

| Domain Error         | API Error       | HTTP Status |
| -------------------- | --------------- | ----------- |
| NotFoundError        | NotFound        | 404         |
| FieldValidationError | InvalidArgument | 400         |
| DuplicateError       | AlreadyExists   | 409         |

## References

- See `AGENTS.md` section "Error Handling" for complete patterns
- See `AGENTS.md` section "Domain-Specific Errors" for Entity Pattern
