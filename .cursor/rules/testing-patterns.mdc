---
description: Testing patterns for Encore applications
globs: apps/server/*/*/*.spec.ts
alwaysApply: false
---

# Testing Patterns

> **ðŸ“– See `AGENTS.md` for complete testing strategy and commands**

## Essential Description

Integration tests with real database (no mocks). Use Vitest. One `feature.controller.spec.ts` file per feature. Use factories for test data. Clean up data in `afterAll`.

## Practical Examples

### Basic Structure

```typescript
import { expect, describe, test, afterAll } from 'vitest';
import { createFeature, deleteFeature } from './feature.controller';

describe('Feature Controller', () => {
  let createdId: number;

  afterAll(async () => {
    if (createdId) {
      try {
        await deleteFeature({ id: createdId });
      } catch (error) {
        console.log('Error cleaning up:', error);
      }
    }
  });

  test('should create a new feature', async () => {
    const response = await createFeature({ name: 'Test' });
    createdId = response.id;
    expect(response.name).toBe('Test');
  });
});
```

### With Factories

```typescript
import { getFactoryDb } from '@/tests/factories';
import { stateFactory } from '@/tests/factories/states.factory';

describe('Feature Controller', () => {
  const factoryDb = getFactoryDb(db);
  let testState: State;
  let createdId: number;

  beforeAll(async () => {
    testState = await stateFactory(factoryDb).create();
  });

  afterAll(async () => {
    if (createdId) {
      await deleteFeature({ id: createdId });
    }
    await stateRepository.deleteAll();
  });

  test('should create feature with dependencies', async () => {
    const response = await createFeature({
      name: 'Test',
      stateId: testState.id,
    });
    createdId = response.id;
    expect(response.stateId).toBe(testState.id);
  });
});
```

### Pagination and Filters

```typescript
test('should return paginated results with filters', async () => {
  const response = await listFeaturesPaginated({
    filters: { active: true },
    orderBy: [{ field: schema.name, direction: 'asc' }],
    page: 1,
    pageSize: 10,
  });

  expect(response.pagination.currentPage).toBe(1);
  expect(response.data.every((f) => f.active === true)).toBe(true);
});
```

## References

- See `AGENTS.md` section "Testing" for complete strategy
- Run tests: `encore test` from project root
